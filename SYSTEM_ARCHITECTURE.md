# ğŸ—ï¸ KIáº¾N TRÃšC Tá»”NG THá»‚ Há»† THá»NG SMART GARDEN

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   ğŸŒ INTERNET / CLOUD                                        â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“¡ OpenWeatherMap API                                                               â”‚   â”‚
â”‚  â”‚  â€¢ Endpoint: api.openweathermap.org/data/2.5/forecast                               â”‚   â”‚
â”‚  â”‚  â€¢ Response: Dá»± bÃ¡o thá»i tiáº¿t 5 ngÃ y (má»—i 3h)                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                            â”‚ HTTP GET (Java)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ğŸ’» SERVER (Docker Containers)                                   â”‚
â”‚                                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â˜• SPRING BOOT BACKEND (Java 21) - Port 8080                                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚  ğŸ“¦ Controllers (REST API)                                                   â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ DeviceController: /api/v1/devices/{uid}/state [GET]                    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ DeviceController: /api/v1/devices/{uid}/command [POST]                 â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ AiChatController: /api/v1/ai/chat [POST]                               â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚                    â”‚                                   â”‚                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  ğŸ”§ Services                         â”‚  â”‚  ğŸ¤– AI Chat Service              â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ DeviceService                   â”‚  â”‚    - Tá»•ng há»£p context:           â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ DeviceStateService              â”‚  â”‚      + Device state (Redis)      â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ TelemetryService                â”‚  â”‚      + Weather forecast (API)    â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ CommandService â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€   - Call Python AI Service      â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ NotificationService             â”‚  â”‚    - Execute tool calls          â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ MqttProcessingService           â”‚  â”‚    - Send email notifications    â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ GardenAutomationService         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚  â”‚      (Scheduled: má»—i 1 phÃºt)         â”‚                 â”‚ HTTP POST              â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                        â”‚    â”‚
â”‚  â”‚         â”‚                â”‚                                 â”‚                        â”‚    â”‚
â”‚  â”‚         â”‚ MQTT Publish   â”‚ Read/Write                      â”‚                        â”‚    â”‚
â”‚  â”‚         â”‚ Subscribe      â”‚                                 â”‚                        â”‚    â”‚
â”‚  â”‚         â”‚                â”‚                                 â”‚                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                â”‚                                 â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“® MOSQUITTO MQTT BROKER - Port 1883                      â”‚                        â”‚   â”‚
â”‚  â”‚  Topics:                                                   â”‚                        â”‚   â”‚
â”‚  â”‚    â€¢ smartgarden/device/ESP32_GARDEN_001/telemetry (Sub)  â”‚                        â”‚   â”‚
â”‚  â”‚    â€¢ smartgarden/device/ESP32_GARDEN_001/status (Sub)     â”‚                        â”‚   â”‚
â”‚  â”‚    â€¢ smartgarden/device/ESP32_GARDEN_001/command (Pub)    â”‚                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                 â”‚                 â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ—„ï¸ MySQL DATABASE - Port 3306            â”‚                 â”‚                        â”‚   â”‚
â”‚  â”‚    Tables:                                â”‚                 â”‚                        â”‚   â”‚
â”‚  â”‚      â€¢ devices (device_uid, auto_mode)   â”‚                 â”‚                        â”‚   â”‚
â”‚  â”‚      â€¢ telemetry_logs (temp, humidity)   â”‚                 â”‚                        â”‚   â”‚
â”‚  â”‚      â€¢ threshold_settings                â”‚                 â”‚                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                        â”‚   â”‚
â”‚                                             â”‚                 â”‚                        â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’¾ REDIS CACHE - Port 6379                                â”‚                        â”‚   â”‚
â”‚  â”‚    Keys:                                                   â”‚                        â”‚   â”‚
â”‚  â”‚      â€¢ device:state:ESP32_GARDEN_001                       â”‚                        â”‚   â”‚
â”‚  â”‚        {status, pump_state, sensors, control_mode}         â”‚                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ PYTHON AI SERVICE (FastAPI) - Port 8000                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  POST /chat                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Request Body:                                                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    {                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      "user_message": "PhÃ¢n tÃ­ch tráº¡ng thÃ¡i vÆ°á»n...",                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      "device_uid": "ESP32_GARDEN_001",                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      "garden_context": {                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚        "sensors": {temp, air_humidity, soil_moisture},                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚        "pump_state": "OFF", "control_mode": "AUTO"                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      },                                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      "weather_context": {                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚        "forecast": [{temp, humidity, rain_probability}],                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚        "will_rain_soon": true/false                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      }                                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    }                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                         â”‚                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ¤– Gemini AI (Google) - gemini-flash-latest                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    Prompt includes:                                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â€¢ System instructions (role: garden AI assistant)                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â€¢ Current garden context (sensors, pump state)                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â€¢ Weather forecast (rain prediction)                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â€¢ Tool definition: controlDevice                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    Response:                                                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â€¢ Type: TEXT hoáº·c TOOL_CALL                                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â€¢ If TOOL_CALL:                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚        {                                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚          "tool_name": "controlDevice",                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚          "arguments": {                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚            "deviceUid": "ESP32_GARDEN_001",                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚            "deviceName": "PUMP",                                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚            "turnOn": true,                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚            "durationMinutes": 12                                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚          }                                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚        }                                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“§ GMAIL SMTP SERVICE - smtp.gmail.com:587                                         â”‚  â”‚
â”‚  â”‚    â€¢ From: tatruongvuptit@gmail.com (App Password)                                  â”‚  â”‚
â”‚  â”‚    â€¢ To: tatruongvu1708@gmail.com                                                   â”‚  â”‚
â”‚  â”‚    â€¢ Subject: AI Notification / Cáº£nh bÃ¡o tá»« AI                                      â”‚  â”‚
â”‚  â”‚    â€¢ Body: Chi tiáº¿t vá» sensor, thá»i tiáº¿t, hÃ nh Ä‘á»™ng Ä‘á» xuáº¥t                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â–²
                                             â”‚ HTTP GET/POST
                                             â”‚ WebSocket (SockJS/STOMP)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 ğŸ–¥ï¸ FRONTEND (React.js)                                      â”‚
â”‚                                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“± Pages                                                                            â”‚    â”‚
â”‚  â”‚    â€¢ Dashboard.js        â†’ GET /api/v1/devices/{uid}/state                         â”‚    â”‚
â”‚  â”‚      - Real-time monitor via WebSocket (/ws-endpoint)                              â”‚    â”‚
â”‚  â”‚      - Display: temp, humidity, soil moisture, pump state                          â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚    â€¢ Control.js          â†’ POST /api/v1/devices/{uid}/command                      â”‚    â”‚
â”‚  â”‚      - Manual control pump (ON/OFF with duration)                                  â”‚    â”‚
â”‚  â”‚      - Switch AUTO/MANUAL mode                                                      â”‚    â”‚
â”‚  â”‚      - Payload: {action: "CONTROL_PUMP", payload: {state: "ON", time: 600}}       â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚    â€¢ Chat.js             â†’ Direct call to Gemini API                               â”‚    â”‚
â”‚  â”‚      - User chat with AI (separate from automation)                                â”‚    â”‚
â”‚  â”‚      - Get device state for context                                                â”‚    â”‚
â”‚  â”‚      - Display markdown responses                                                  â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚    â€¢ History.js          â†’ GET /api/v1/telemetry/history                           â”‚    â”‚
â”‚  â”‚      - Chart.js display historical data                                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â–²
                                             â”‚ MQTT (WiFi)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ğŸ”§ HARDWARE (ESP32 & SENSORS)                                   â”‚
â”‚                                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“¡ ESP32 DevKit v1 (WiFi + MQTT Client)                                            â”‚    â”‚
â”‚  â”‚    Device UID: ESP32_GARDEN_001                                                     â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚  ğŸ“¤ MQTT Publish (má»—i 5 giÃ¢y)                                                â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Topic: smartgarden/device/ESP32_GARDEN_001/telemetry                   â”‚   â”‚    â”‚
â”‚  â”‚  â”‚      Payload: {                                                              â”‚   â”‚    â”‚
â”‚  â”‚  â”‚        "sensors": {                                                          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚          "temperature": 23.4,      â† DHT22                                  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚          "air_humidity": 61.0,     â† DHT22                                  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚          "soil_moisture": 35.2,    â† Soil Moisture Sensor                  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚          "light": 450.0            â† LDR (bá»‹ AI ignore)                    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚        }                                                                     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚      }                                                                       â”‚   â”‚    â”‚
â”‚  â”‚  â”‚                                                                              â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Topic: smartgarden/device/ESP32_GARDEN_001/status                     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚      Payload: {"status": "ONLINE", "timestamp": 7380381}                   â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚  ğŸ“¥ MQTT Subscribe                                                           â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Topic: smartgarden/device/ESP32_GARDEN_001/command                     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚      Payload: {                                                              â”‚   â”‚    â”‚
â”‚  â”‚  â”‚        "action": "CONTROL_PUMP",                                            â”‚   â”‚    â”‚
â”‚  â”‚  â”‚        "payload": {                                                          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚          "state": "ON",           â† Báº­t/Táº¯t                                 â”‚   â”‚    â”‚
â”‚  â”‚  â”‚          "time": 720              â† Thá»i gian tÆ°á»›i (giÃ¢y)                  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚        }                                                                     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚      }                                                                       â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â†’ Execute: Báº­t Relay â†’ MÃ¡y bÆ¡m hoáº¡t Ä‘á»™ng                                â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    â†’ Auto OFF sau 720s (12 phÃºt)                                            â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”Œ HARDWARE CONNECTIONS                                                            â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    ESP32 GPIO Pins:                                                                 â”‚   â”‚
â”‚  â”‚      â€¢ GPIO 4  â”€â”€â”€â”€â”€â”€â–º DHT22 Sensor (Temperature & Air Humidity)                   â”‚   â”‚
â”‚  â”‚      â€¢ GPIO 34 â”€â”€â”€â”€â”€â”€â–º Soil Moisture Sensor (Analog)                               â”‚   â”‚
â”‚  â”‚      â€¢ GPIO 35 â”€â”€â”€â”€â”€â”€â–º LDR Light Sensor (Analog) - IGNORED BY AI                   â”‚   â”‚
â”‚  â”‚      â€¢ GPIO 26 â”€â”€â”€â”€â”€â”€â–º Relay Module (Active LOW)                                   â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    âš¡ Power Supply:                                                                  â”‚   â”‚
â”‚  â”‚      â€¢ ESP32: 5V/2A USB                                                             â”‚   â”‚
â”‚  â”‚      â€¢ Relay: VCC=5V, GND, IN=GPIO26                                                â”‚   â”‚
â”‚  â”‚      â€¢ Sensors: 3.3V from ESP32                                                     â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    ğŸš° Relay â†’ Water Pump:                                                            â”‚   â”‚
â”‚  â”‚      â€¢ Relay COM â”€â”€â–º Power 12V DC                                                   â”‚   â”‚
â”‚  â”‚      â€¢ Relay NO  â”€â”€â–º Water Pump (+)                                                 â”‚   â”‚
â”‚  â”‚      â€¢ Pump (-)  â”€â”€â–º Power GND                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            ğŸ“Š LUá»’NG Dá»® LIá»†U CHÃNH (DATA FLOWS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£  TELEMETRY FLOW (Sensor Data Collection)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ESP32 Sensors â”€â”€(Read every 5s)â”€â”€â–º ESP32 Firmware â”€â”€(MQTT Publish)â”€â”€â–º Mosquitto Broker
                                                                              â”‚
                                                                              â–¼
                                    Spring Boot (MqttProcessingService) â—„â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â–¼                       â–¼
                            Save to MySQL           Update Redis Cache
                         (TelemetryService)       (DeviceStateService)
                                                            â”‚
                                                            â–¼
                                                  Broadcast WebSocket
                                                (NotificationService)
                                                            â”‚
                                                            â–¼
                                              React Frontend (Real-time Update)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£  AI AUTOMATION FLOW (Scheduled Task - Every 1 minute)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Spring Boot Scheduler (@Scheduled)
         â”‚
         â–¼
GardenAutomationService.runProactiveAutomation()
         â”‚
         â”œâ”€â”€â–º Check device mode from MySQL
         â”‚    (AUTO or MANUAL?)
         â”‚
         â”œâ”€â”€â–º Collect context:
         â”‚    â€¢ DeviceStateService.getState() â†’ Redis
         â”‚    â€¢ WeatherService.getForecast() â†’ OpenWeatherMap API
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Is AUTO mode?                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚
      YESâ”‚            â”‚NO (MANUAL)
         â”‚            â”‚
         â–¼            â–¼
    analysis()    getChatResponse()
         â”‚            â”‚
         â”‚            â””â”€â”€â–º Call Python AI
         â”‚                      â”‚
         â”‚                      â”œâ”€â”€â–º If TOOL_CALL: Send Email ONLY
         â”‚                      â””â”€â”€â–º No execution
         â”‚
         â””â”€â”€â–º Call Python AI â”€â”€â–º Gemini
                    â”‚
                    â”œâ”€â”€â–º If TOOL_CALL:
                    â”‚    â”œâ”€â–º Execute command (CommandService)
                    â”‚    â”‚   â””â”€â”€â–º MQTT Publish to ESP32
                    â”‚    â”‚        â””â”€â”€â–º ESP32 turns ON pump with timer
                    â”‚    â”‚
                    â”‚    â””â”€â–º Send Email (NotificationService)
                    â”‚
                    â””â”€â”€â–º If TEXT: Log only


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£  MANUAL CONTROL FLOW (User Command from Frontend)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

React Frontend (Control.js)
         â”‚
         â”œâ”€â”€â–º User clicks "Báº­t mÃ¡y bÆ¡m 10 phÃºt"
         â”‚
         â–¼
POST /api/v1/devices/ESP32_GARDEN_001/command
Body: {
  "action": "CONTROL_PUMP",
  "payload": {"state": "ON", "time": 600}
}
         â”‚
         â–¼
Spring Boot (DeviceController)
         â”‚
         â–¼
CommandService.sendCommand()
         â”‚
         â”œâ”€â”€â–º Update Redis immediately (optimistic update)
         â”œâ”€â”€â–º Broadcast WebSocket (frontend sees change instantly)
         â”‚
         â–¼
MQTT Publish â†’ smartgarden/device/ESP32_GARDEN_001/command
         â”‚
         â–¼
ESP32 receives command
         â”‚
         â”œâ”€â”€â–º Turn ON relay (GPIO 26 = LOW)
         â”œâ”€â”€â–º Water pump starts
         â”œâ”€â”€â–º Set timer for 600 seconds
         â””â”€â”€â–º Auto turn OFF after timer expires


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£  CHAT FLOW (User Chat with AI)                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

React Frontend (Chat.js)
         â”‚
         â”œâ”€â”€â–º User types: "TÃ´i nÃªn tÆ°á»›i nÆ°á»›c khÃ´ng?"
         â”‚
         â”œâ”€â”€â–º Fetch device state: GET /api/v1/devices/{uid}/state
         â”‚
         â–¼
Build context prompt with sensor data
         â”‚
         â–¼
Direct call to Gemini API (gemini-flash-latest)
(Not going through backend AI service)
         â”‚
         â–¼
Display AI response in chat (Markdown format)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              ğŸ”§ TECHNOLOGY STACK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Backend:
  â€¢ Spring Boot 3.x (Java 21)
  â€¢ Spring Integration MQTT
  â€¢ Spring Data JPA + Hibernate
  â€¢ Spring Data Redis
  â€¢ Eclipse Paho MQTT Client
  â€¢ RestClient (HTTP calls)
  â€¢ JavaMailSender (SMTP)

Database & Cache:
  â€¢ MySQL 8.0
  â€¢ Redis 7.x
  â€¢ Flyway Migration

Message Broker:
  â€¢ Eclipse Mosquitto (MQTT 3.1.1)

AI Services:
  â€¢ Python 3.11 + FastAPI
  â€¢ Google Gemini API (gemini-flash-latest)
  â€¢ Pydantic (data validation)

Frontend:
  â€¢ React.js 18
  â€¢ TailwindCSS 3
  â€¢ SockJS + STOMP (WebSocket)
  â€¢ Chart.js (data visualization)
  â€¢ React Markdown

Hardware:
  â€¢ ESP32 DevKit v1
  â€¢ DHT22 (Temperature & Humidity)
  â€¢ Capacitive Soil Moisture Sensor
  â€¢ LDR Light Sensor
  â€¢ 5V Relay Module
  â€¢ 12V DC Water Pump

DevOps:
  â€¢ Docker + Docker Compose
  â€¢ Multi-stage builds (Maven, Python)
  â€¢ Container orchestration


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            ğŸ” SECURITY & CONFIGURATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Environment Variables (.env):
  â€¢ SPRING_DATASOURCE_URL=jdbc:mysql://mysql_db:3306/iot_db
  â€¢ SPRING_DATASOURCE_USERNAME=root
  â€¢ SPRING_DATASOURCE_PASSWORD=root_password
  â€¢ MQTT_BROKER_URL=tcp://mqtt_broker:1883
  â€¢ MQTT_USERNAME=iot_admin
  â€¢ MQTT_PASSWORD=123456
  â€¢ SPRING_REDIS_HOST=redis_cache
  â€¢ AI_SERVICE_URL=http://python-ai:8000
  â€¢ OPENWEATHERMAP_API_KEY=e2af82a68f3bc2bb28f019259585fdad
  â€¢ GEMINI_API_KEY=AIzaSyA7Pc6IkEpCKqsJaogq4JbXgw6VcGgFD5g
  â€¢ SPRING_MAIL_USERNAME=tatruongvuptit@gmail.com
  â€¢ SPRING_MAIL_PASSWORD=[Gmail App Password]

Ports:
  â€¢ Frontend: 3000
  â€¢ Backend: 8080
  â€¢ Python AI: 8000
  â€¢ MySQL: 13306 (mapped from 3306)
  â€¢ Redis: 6379
  â€¢ MQTT: 18883 (mapped from 1883)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              ğŸ“ˆ KEY FEATURES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Real-time sensor monitoring via MQTT & WebSocket
âœ… AI-powered automated watering with weather forecast integration
âœ… Manual control with timed watering (duration in seconds)
âœ… AUTO/MANUAL mode switching
âœ… Email notifications for AI decisions (MANUAL mode) and actions (AUTO mode)
âœ… Historical data visualization with Chart.js
âœ… Chat interface with AI assistant
âœ… Optimistic UI updates (Redis cache + WebSocket broadcast)
âœ… Scheduled AI analysis every 1 minute
âœ… Weather-aware irrigation (skip if rain predicted)
âœ… Multi-container Docker deployment
âœ… Persistent data storage with MySQL
âœ… Redis caching for fast state retrieval


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          ğŸš€ DEPLOYMENT ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

docker-compose.yml defines 5 services:

1. mysql_db (MySQL 8.0)
   - Volume: mysql_data
   - Healthcheck: mysqladmin ping

2. redis_cache (Redis 7)
   - Volume: redis_data

3. mqtt_broker (Eclipse Mosquitto)
   - Custom config with authentication
   - Volume: mosquitto/config

4. python-ai (FastAPI)
   - Depends on: none (stateless)
   - Environment: GEMINI_API_KEY

5. app (Spring Boot)
   - Depends on: mysql_db, redis_cache, mqtt_broker
   - Multi-stage build with Maven
   - Healthcheck: HTTP GET localhost:8080/actuator/health

Networks:
  - All containers on same bridge network (template_default)
  - Services communicate via container names (mysql_db, redis_cache, etc.)

Volumes:
  - mysql_data (persistent)
  - redis_data (persistent)
  - mosquitto config (bind mount)
